<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Title</title>
	<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</head>
<!-- # TODO: get rid of the need to make margin =0 -->
<body id="body" style="margin: 0;">

    <div>
    </div>

 
    
    <script>


        var create_svg=function(x,y,w,h)
        {
            var NS="http://www.w3.org/2000/svg";
            var svg=document.createElementNS(NS,"svg");
            //set svg style
                svg.style.border= "1px solid black";
                svg.style.position= "fixed";
                svg.style.top= y + "px";  //position relative to the window
                svg.style.left= x + "px";

            //set svg attributes
                svg.setAttribute("height", h);
                svg.setAttribute("width", w);

            return svg;
        }
        var create_rect=function(x,y,w,h,fill)
        {
            var NS="http://www.w3.org/2000/svg";
            var SVGObj= document.createElementNS(NS,"rect");
            SVGObj.width.baseVal.value=w;
            SVGObj.height.baseVal.value=h;
            SVGObj.setAttribute("width",w);
            SVGObj.setAttribute("height",h);
            SVGObj.setAttribute("x", x);
            SVGObj.setAttribute("y", y);
            SVGObj.setAttribute("rx", 20);
            SVGObj.setAttribute("ry", 20);
            SVGObj.style="fill:red;stroke:black;stroke-width:5;opacity:0.5"
            return SVGObj;
        }
        
        //node_content_box class
        function node_content_box(node_id,x,y,w,h) {
            this.node_id=node_id;
            //create svg of the content box
                this.content_box_svg=create_svg(x,y,w,h);
            //add the id to the svg box
                this.content_box_svg.setAttribute("id", "node_content_box_"+node_id);
            //add the svg box to the dom
                document.body.appendChild(this.content_box_svg);
            //create rectangle 
                this.r= create_rect(2,2,w-4,h-4,"blue");
            //add id to the rectangle
                this.r.setAttribute("id", "node_content_box_rect_"+node_id);
            //add the rectangle to the dom
                this.content_box_svg.appendChild( this.r);

            //add mouse events lisnters
            //TODO: find a way to make this modular in some way... this sections makes the class lengthy .. would prefer if there were a way to separate it in other file
                this.clicking = false; // var to know when the box is clicked and when mouse click is up.
                this.click_in_content_box_x=0; // variables to make drag node relative to the point clicked in the node not the upper left corner
                this.click_in_content_box_y=0;
                $('#node_content_box_'+this.node_id).mousedown((event)=>{
                    //find the position of the click relative to the upper left corner of the node
                    var pos_obj = $('#node_content_box_'+this.node_id).position();
                    content_box_x =pos_obj.left;
                    content_box_y =pos_obj.top;
                    this.click_in_content_box_x = event.pageX - content_box_x;
                    this.click_in_content_box_y = event.pageY - content_box_y;
                    //set the glopal variable to true
                    this.clicking = true;
                });
                $(document).mouseup(()=>{
                    this.clicking = false;
                    window.onmousemove = null;
                })
                $('#node_content_box_'+this.node_id).mousemove(()=>{
                    if(this.clicking == false) return;
                    // Mouse click + moving logic here
                    window.onmousemove = this.handle_item_drag;
                });

                this.handle_item_drag =(event)=>{
                    event = event || window.event;
                    var new_x = event.clientX;
                    var new_y= event.clientY;
                    //prevent item from getting out of top and left edges of window .. 
                    //   TODO: make the window resize instead when this happens
                    if(event.clientX < 0)
                    {    new_x = 0;  }
                    if(event.clientY < 0)
                    {    new_y = 0;  }

                    //reset node position to the new values
                    document.getElementById('node_content_box_'+this.node_id).style.top= (new_y - this.click_in_content_box_y) + "px";
                    document.getElementById('node_content_box_'+this.node_id).style.left=(new_x - this.click_in_content_box_x) + "px";

                    //reset node resizer position 
                    var width = document.getElementById('node_content_box_'+this.node_id).getAttribute("width");
                    var height = document.getElementById('node_content_box_'+this.node_id).getAttribute("height");
                    document.getElementById('resiezer_'+this.node_id).style.top= (new_y - this.click_in_content_box_y + Number(height)) + "px";
                    document.getElementById('resiezer_'+this.node_id).style.left=(new_x - this.click_in_content_box_x + Number(width )) + "px";
                } ;

        }









        //resizer class
        function resizer(node_id,x,y,w,h) {
            this.node_id = node_id;
            //create svg of the resizer
                this.resizer_svg1=create_svg(x,y,w,h);
            //add the id to the svg 
                this.resizer_svg1.setAttribute("id", "resiezer_"+node_id);
            //add the svg box to the dom
                document.body.appendChild(this.resizer_svg1);
            //create rectangle 
                this.r2= create_rect(0,0,10,10,"red");
            //add id to the rectangle
                this.r2.setAttribute("id", "resizer_rect_"+node_id);
            //add the rectangle to the dom
                this.resizer_svg1.appendChild(this.r2);

            //add mouse event handlers to the resizer
            this.clicking2 = false; // var to know when the resizer is clicked and when mouse click is up.
            $('#resiezer_'+this.node_id).mousedown((event)=>{
                //set the glopal variable to true
                this.clicking2 = true;
            });
            $(document).mouseup(()=>{
                this.clicking2 = false;
                window.onmousemove = null;
            })
            $('#resiezer_'+this.node_id).mousemove(()=>{
                if(this.clicking2 == false) return;

                // Mouse click + moving logic here
                window.onmousemove = this.handle_item_resize;
            });

            this.handle_item_resize=(event) =>{

                    event = event || window.event;
                    var new_resizer_x = event.clientX; //position of the resizer is the same as the position of the cursor as it moves
                    var new_resizer_y= event.clientY;
                
                    var pos_obj = $("#node_content_box_"+this.node_id).position(); // position of the node the resizer attached to
                    var node_x =pos_obj.left;
                    var node_y =pos_obj.top;

                //prevent item from getting smaller than a specific size .. 
                    var min_width=30;
                    var min_height=30;
                    if(event.clientX - node_x < min_width)
                    {    new_resizer_x = node_x+min_width;  }
                    if(event.clientY -node_y < min_height)
                    {    new_resizer_y = node_y+min_height;  }
                
                //calculate the new size of node    
                    var new_node_width = new_resizer_x - node_x;
                    var new_node_height = new_resizer_y - node_y;

                //change the size of the node 
                    //resize the svg
                    $('#node_content_box_'+this.node_id).attr('height', new_node_height);
                    $('#node_content_box_'+this.node_id).attr('width', new_node_width);
                    //resize the svg content
                    $('#node_content_box_rect_'+this.node_id).attr('height', new_node_height-5);
                    $('#node_content_box_rect_'+this.node_id).attr('width', new_node_width-5);
                //reset node resizer position 
                    document.getElementById('resiezer_'+this.node_id).style.top= (new_resizer_y ) + "px";
                    document.getElementById('resiezer_'+this.node_id).style.left=(new_resizer_x ) + "px";

            };

        }
        
        //node class

       
       
        class node {
            constructor(node_id,x,y,w,h)
            {
                this.node_id=node_id;
                this.content_box = new node_content_box(node_id,x,y,w,h);
                this.resizer     = new resizer(node_id,x+w,y+h,10,10);
                this.get_x = ()=> {
                    var pos_obj = $('#node_content_box_'+this.node_id).position();
                    content_box_x =pos_obj.left;
                    return content_box_x;
                };
                this.get_y = ()=> {
                    var pos_obj = $('#node_content_box_'+this.node_id).position();
                    content_box_y =pos_obj.top;
                    return content_box_y;
                };
                this.get_width = ()=> {
                    var width = document.getElementById('node_content_box_'+this.node_id).getAttribute("width");
                    return width;
                };            
                this.get_height = ()=> {
                    var height = document.getElementById('node_content_box_'+this.node_id).getAttribute("height");
                    return height;
                    };
            }

        }

//    let s1 = new Student(101,'Sachin','Tendulkar')
//    console.log(s1)
//    //setter is called
//    s1.rollno = 201
//    console.log(s1)



        let node_3 = new node(3,200,100,85,85);
        let node_2 = new node(2,200,200,100,300);
        let node_1 = new node(1,200,200,85,85);
        var r= node_1.get_height();
        console.log(r);

    </script>
    
    <!-- <script src="darg_handling.js"> </script> -->
    <!-- <script src="resize_handling.js"> </script> -->

</body>
</html>